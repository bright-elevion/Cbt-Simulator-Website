{% extends "base.html" %}

{% block title %}Study - {{ course }}{% endblock %}

{% block content %}
<div class="quiz-container">
    <div class="timer-bar">
        <span>{{ course }} - Study Mode</span>
        <a href="{{ url_for('index') }}" style="color: var(--primary-blue); text-decoration: none; font-size: 14px;">Exit</a>
    </div>

    <div class="progress-container">
        <div id="progress" class="progress-bar"></div>
    </div>

    <!-- Question Navigation Bar -->
    <div class="question-nav-container">
        <div class="nav-header">
            <span class="question-count-badge"><span id="total-questions-badge">0</span> Questions</span>
            <i class="fas fa-chevron-up nav-toggle"></i>
        </div>
        <div id="question-numbers" class="question-numbers-grid">
            <!-- Numbers will be generated by JS -->
        </div>
    </div>

    <p style="font-size: 14px; color: #666; margin-bottom: 20px; margin-top: 10px;">
        Question <span id="current-question">1</span> of <span id="total-questions">0</span>
    </p>

    <div class="question-box">
        <h3 id="question-text">Loading question...</h3>
        
        <div class="options-list" id="options-container">
            <label class="option-item" data-option="A">
                <input type="radio" name="answer" value="A">
                <span id="option-a"></span>
            </label>
            <label class="option-item" data-option="B">
                <input type="radio" name="answer" value="B">
                <span id="option-b"></span>
            </label>
            <label class="option-item" data-option="C">
                <input type="radio" name="answer" value="C">
                <span id="option-c"></span>
            </label>
            <label class="option-item" data-option="D">
                <input type="radio" name="answer" value="D">
                <span id="option-d"></span>
            </label>
        </div>

        <div id="feedback-box" class="solution-box" style="display: none; margin-top: 20px;">
            <div id="feedback-status" style="font-weight: 700; margin-bottom: 10px;"></div>
            <div class="solution-title">Step-by-Step Solution:</div>
            <div id="solution-text" class="solution-text"></div>
        </div>
    </div>

    <div class="btn-group">
        <button type="button" id="prev-btn" class="btn btn-prev" style="display:none;">Previous</button>
        <button type="button" id="check-btn" class="btn btn-next" style="background: #4caf50;">Check Answer</button>
        <button type="button" id="next-btn" class="btn btn-next">Next</button>
    </div>
</div>

<script>
let questions = [];
let currentQuestionIndex = 0;
let userAnswers = {};
let checkedQuestions = new Set();
const numQuestions = {{ session.get('num_questions', 10) }};
const course = "{{ course }}";

async function loadQuestions() {
    try {
        const response = await fetch(`/api/questions?course=${encodeURIComponent(course)}&limit=${numQuestions}`);
        if (!response.ok) {
            alert('Failed to load questions for this course');
            window.location.href = '/study-courses';
            return;
        }
        questions = await response.json();
        document.getElementById('total-questions').textContent = questions.length;
        document.getElementById('total-questions-badge').textContent = questions.length;
        generateQuestionNumbers();
        displayQuestion();
    } catch (error) {
        console.error('Error loading questions:', error);
        alert('Failed to load questions. Please try again.');
        window.location.href = '/study-courses';
    }
}

function displayQuestion() {
    if (questions.length === 0) return;
    
    const q = questions[currentQuestionIndex];
    document.getElementById('question-text').textContent = q.question_text;
    document.getElementById('option-a').textContent = q.option_a;
    document.getElementById('option-b').textContent = q.option_b;
    document.getElementById('option-c').textContent = q.option_c;
    document.getElementById('option-d').textContent = q.option_d;
    document.getElementById('current-question').textContent = currentQuestionIndex + 1;
    
    const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
    document.getElementById('progress').style.width = progress + '%';

    // Reset options styling
    document.querySelectorAll('.option-item').forEach(item => {
        item.classList.remove('correct', 'incorrect', 'selected');
        const radio = item.querySelector('input');
        radio.disabled = false;
    });

    const saved = userAnswers[currentQuestionIndex];
    document.querySelectorAll('input[name="answer"]').forEach(r => {
        r.checked = r.value === saved;
        if (r.value === saved) {
            r.parentElement.classList.add('selected');
        }
    });
    
    // If already checked, show feedback
    if (checkedQuestions.has(currentQuestionIndex)) {
        showFeedback();
    } else {
        document.getElementById('feedback-box').style.display = 'none';
        document.getElementById('check-btn').style.display = 'block';
    }

    // Update active state in navigation bar
    document.querySelectorAll('.q-num').forEach((el, idx) => {
        if (idx === currentQuestionIndex) {
            el.classList.add('active');
        } else {
            el.classList.remove('active');
        }
        
        if (userAnswers[idx]) {
            el.classList.add('answered');
        }
    });

    document.getElementById('prev-btn').style.display = currentQuestionIndex > 0 ? 'block' : 'none';
    document.getElementById('next-btn').style.display = currentQuestionIndex < questions.length - 1 ? 'block' : 'none';
}

function generateQuestionNumbers() {
    const container = document.getElementById('question-numbers');
    container.innerHTML = '';
    questions.forEach((_, index) => {
        const btn = document.createElement('div');
        btn.className = 'q-num';
        btn.textContent = index + 1;
        btn.onclick = () => {
            saveAnswer();
            currentQuestionIndex = index;
            displayQuestion();
        };
        container.appendChild(btn);
    });
}

function saveAnswer() {
    const selected = document.querySelector('input[name="answer"]:checked');
    if (selected) userAnswers[currentQuestionIndex] = selected.value;
}

function showFeedback() {
    const q = questions[currentQuestionIndex];
    const userAnswer = userAnswers[currentQuestionIndex];
    const correctAnswer = q.correct_option;
    
    document.querySelectorAll('.option-item').forEach(item => {
        const opt = item.getAttribute('data-option');
        const radio = item.querySelector('input');
        radio.disabled = true;
        
        if (opt === correctAnswer) {
            item.classList.add('correct');
        } else if (opt === userAnswer && userAnswer !== correctAnswer) {
            item.classList.add('incorrect');
        }
    });

    const feedbackBox = document.getElementById('feedback-box');
    const feedbackStatus = document.getElementById('feedback-status');
    const solutionText = document.getElementById('solution-text');

    feedbackBox.style.display = 'block';
    if (userAnswer === correctAnswer) {
        feedbackStatus.textContent = "Correct!";
        feedbackStatus.style.color = "#2e7d32";
    } else if (!userAnswer) {
        feedbackStatus.textContent = "Not answered. Correct answer is " + correctAnswer;
        feedbackStatus.style.color = "#666";
    } else {
        feedbackStatus.textContent = "Incorrect. Correct answer is " + correctAnswer;
        feedbackStatus.style.color = "#c62828";
    }
    
    solutionText.textContent = q.solution;
    document.getElementById('check-btn').style.display = 'none';
    checkedQuestions.add(currentQuestionIndex);
}

document.getElementById('check-btn').onclick = () => {
    saveAnswer();
    showFeedback();
};

document.getElementById('next-btn').onclick = () => { 
    saveAnswer(); 
    if (currentQuestionIndex < questions.length - 1) {
        currentQuestionIndex++; 
        displayQuestion();
    }
};

document.getElementById('prev-btn').onclick = () => { 
    saveAnswer(); 
    if (currentQuestionIndex > 0) {
        currentQuestionIndex--; 
        displayQuestion();
    }
};

// Add click listener for option items to handle selection styling
document.getElementById('options-container').addEventListener('click', (e) => {
    const item = e.target.closest('.option-item');
    if (item && !item.querySelector('input').disabled) {
        document.querySelectorAll('.option-item').forEach(i => i.classList.remove('selected'));
        item.classList.add('selected');
        item.querySelector('input').checked = true;
    }
});

window.onload = loadQuestions;
</script>
{% endblock %}
