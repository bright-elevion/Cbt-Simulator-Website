{% extends "base.html" %}

{% block title %}Result - PrepCampus CBT{% endblock %}

{% block content %}
<div class="quiz-container">
    <div id="summary-view">
        <div class="result-box">
            <div class="score-circle">
                <span class="score-val">{{ score }}/{{ total }}</span>
                <span style="font-size: 14px; color: #666;">Your Score</span>
            </div>
            
            <h2 style="margin-bottom: 10px;">{{ "Excellent!" if (score/total) >= 0.7 else "Good Job!" if (score/total) >= 0.5 else "Keep Practicing!" }}</h2>
            <p style="color: #666; margin-bottom: 30px;">You have completed the {{ course }} practice test.</p>
            
            <div class="btn-group" style="flex-direction: column;">
                <button id="review-btn" class="btn btn-next" style="width: 100%; margin-bottom: 10px;">Review Questions</button>
                <a href="{{ url_for('index') }}" class="btn btn-prev" style="width: 100%; text-align: center; text-decoration: none;">Back to Home</a>
            </div>
        </div>
    </div>

    <!-- Review Mode (Hidden by default) -->
    <div id="review-view" style="display: none;">
        <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 15px;">
            <button id="back-to-summary" style="background: none; border: none; color: var(--text-dark); font-size: 20px; cursor: pointer;">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div>
                <h2 style="font-size: 20px; font-weight: 700;">Review Mode</h2>
                <p style="color: #666; font-size: 14px;">Study your answers and correct ones</p>
            </div>
        </div>

        <div class="question-nav-container">
            <div class="nav-header">
                <span class="question-count-badge"><span id="total-questions-badge">{{ total }}</span> Questions</span>
            </div>
            <div id="question-numbers" class="question-numbers-grid">
                <!-- Numbers will be generated by JS -->
            </div>
        </div>

        <p style="font-size: 14px; color: #666; margin-bottom: 20px; margin-top: 10px;">
            Question <span id="current-question">1</span> of <span id="total-questions">{{ total }}</span>
        </p>

        <div class="question-box">
            <h3 id="question-text">Loading question...</h3>
            
            <div class="options-list">
                <div class="option-item" id="option-a-container">
                    <span style="margin-right: 10px; font-weight: bold;">A.</span>
                    <span id="option-a"></span>
                </div>
                <div class="option-item" id="option-b-container">
                    <span style="margin-right: 10px; font-weight: bold;">B.</span>
                    <span id="option-b"></span>
                </div>
                <div class="option-item" id="option-c-container">
                    <span style="margin-right: 10px; font-weight: bold;">C.</span>
                    <span id="option-c"></span>
                </div>
                <div class="option-item" id="option-d-container">
                    <span style="margin-right: 10px; font-weight: bold;">D.</span>
                    <span id="option-d"></span>
                </div>
            </div>

            <div id="solution-container" class="solution-box" style="display: none; margin-top: 20px;">
                <div class="solution-title">Step-by-Step Solution:</div>
                <div id="solution-text" class="solution-text"></div>
            </div>
            
            <button id="toggle-solution-btn" class="btn btn-next" style="margin-top: 15px; width: auto; padding: 8px 15px;">
                Check Step-by-Step
            </button>
        </div>

        <div class="btn-group">
            <button type="button" id="prev-btn" class="btn btn-prev">Previous</button>
            <button type="button" id="next-btn" class="btn btn-next">Next</button>
        </div>
    </div>
</div>

<style>
    .correct {
        background-color: #e8f5e9 !important;
        border-color: #4caf50 !important;
    }
    .incorrect {
        background-color: #ffebee !important;
        border-color: #f44336 !important;
    }
    .q-num.correct-nav {
        background-color: #e8f5e9;
        color: #2e7d32;
    }
    .q-num.incorrect-nav {
        background-color: #ffebee;
        color: #c62828;
    }
</style>

<script>
let reviewData = [];
let currentIdx = 0;

async function loadReviewData() {
    try {
        const res = await fetch('/api/review-data');
        reviewData = await res.json();
        generateNav();
        displayQuestion();
    } catch (err) {
        console.error('Error loading review data:', err);
    }
}

function generateNav() {
    const container = document.getElementById('question-numbers');
    container.innerHTML = '';
    reviewData.forEach((q, i) => {
        const btn = document.createElement('div');
        btn.className = 'q-num';
        if (q.user_answer === q.correct_answer) {
            btn.classList.add('correct-nav');
        } else if (q.user_answer !== null) {
            btn.classList.add('incorrect-nav');
        }
        btn.textContent = i + 1;
        btn.onclick = () => {
            currentIdx = i;
            displayQuestion();
        };
        container.appendChild(btn);
    });
}

function displayQuestion() {
    if (reviewData.length === 0) return;
    const q = reviewData[currentIdx];
    
    document.getElementById('question-text').textContent = q.question_text;
    document.getElementById('option-a').textContent = q.option_a;
    document.getElementById('option-b').textContent = q.option_b;
    document.getElementById('option-c').textContent = q.option_c;
    document.getElementById('option-d').textContent = q.option_d;
    document.getElementById('current-question').textContent = currentIdx + 1;
    
    // Reset solution
    document.getElementById('solution-container').style.display = 'none';
    document.getElementById('solution-text').textContent = q.solution || "No detailed solution available.";

    // Reset styles
    ['a', 'b', 'c', 'd'].forEach(opt => {
        const container = document.getElementById(`option-${opt}-container`);
        container.className = 'option-item';
        
        const val = opt.toUpperCase();
        if (val === q.correct_answer) {
            container.classList.add('correct');
        }
        if (val === q.user_answer && val !== q.correct_answer) {
            container.classList.add('incorrect');
        }
    });

    // Update nav active
    document.querySelectorAll('.q-num').forEach((el, i) => {
        if (i === currentIdx) el.classList.add('active');
        else el.classList.remove('active');
    });

    document.getElementById('prev-btn').style.visibility = currentIdx > 0 ? 'visible' : 'hidden';
    document.getElementById('next-btn').style.visibility = currentIdx < reviewData.length - 1 ? 'visible' : 'hidden';
}

document.getElementById('review-btn').onclick = () => {
    document.getElementById('summary-view').style.display = 'none';
    document.getElementById('review-view').style.display = 'block';
    loadReviewData();
};

document.getElementById('back-to-summary').onclick = () => {
    document.getElementById('summary-view').style.display = 'block';
    document.getElementById('review-view').style.display = 'none';
};

document.getElementById('next-btn').onclick = () => {
    if (currentIdx < reviewData.length - 1) {
        currentIdx++;
        displayQuestion();
    }
};

document.getElementById('prev-btn').onclick = () => {
    if (currentIdx > 0) {
        currentIdx--;
        displayQuestion();
    }
};

document.getElementById('toggle-solution-btn').onclick = () => {
    const container = document.getElementById('solution-container');
    if (container.style.display === 'none') {
        container.style.display = 'block';
    } else {
        container.style.display = 'none';
    }
};
</script>
{% endblock %}
