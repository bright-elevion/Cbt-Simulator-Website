{% extends "base.html" %}

{% block title %}Quiz - {{ course }}{% endblock %}

{% block content %}
<div class="quiz-container">
    <div class="timer-bar">
        <span>{{ course }}</span>
        <span id="timer">30:00</span>
    </div>

    <div class="progress-container">
        <div id="progress" class="progress-bar"></div>
    </div>

    <!-- Question Navigation Bar -->
    <div class="question-nav-container">
        <div class="nav-header">
            <span class="question-count-badge"><span id="total-questions-badge">10</span> Questions</span>
            <i class="fas fa-chevron-up nav-toggle"></i>
        </div>
        <div id="question-numbers" class="question-numbers-grid">
            <!-- Numbers will be generated by JS -->
        </div>
    </div>

    <p style="font-size: 14px; color: #666; margin-bottom: 20px; margin-top: 10px;">
        Question <span id="current-question">1</span> of <span id="total-questions">10</span>
    </p>

    <form id="quiz-form">
        <div class="question-box">
            <h3 id="question-text">Loading question...</h3>
            
            <div class="options-list">
                <label class="option-item">
                    <input type="radio" name="answer" value="A">
                    <span id="option-a"></span>
                </label>
                <label class="option-item">
                    <input type="radio" name="answer" value="B">
                    <span id="option-b"></span>
                </label>
                <label class="option-item">
                    <input type="radio" name="answer" value="C">
                    <span id="option-c"></span>
                </label>
                <label class="option-item">
                    <input type="radio" name="answer" value="D">
                    <span id="option-d"></span>
                </label>
            </div>
        </div>

        <div class="btn-group">
            <button type="button" id="prev-btn" class="btn btn-prev" style="display:none;">Previous</button>
            <button type="button" id="next-btn" class="btn btn-next">Next</button>
            <button type="submit" id="submit-btn" class="btn btn-next" style="display:none; background: #4caf50;">Submit</button>
        </div>
    </form>
</div>

<script>
let questions = [];
let currentQuestionIndex = 0;
let userAnswers = {};
let timeRemaining = {{ session.get('duration_seconds', 1800) }};
const numQuestions = {{ session.get('num_questions', 10) }};
const course = "{{ course }}";

async function loadQuestions() {
    try {
        const response = await fetch(`/api/questions?course=${encodeURIComponent(course)}&limit=${numQuestions}`);
        if (!response.ok) {
            alert('Failed to load questions for this course');
            window.location.href = '/free-courses';
            return;
        }
        questions = await response.json();
        document.getElementById('total-questions').textContent = questions.length;
        document.getElementById('total-questions-badge').textContent = questions.length;
        generateQuestionNumbers();
        displayQuestion();
        startTimer();
    } catch (error) {
        console.error('Error loading questions:', error);
        alert('Failed to load questions. Please try again.');
        window.location.href = '/free-courses';
    }
}

function displayQuestion() {
    if (questions.length === 0) return;
    
    const q = questions[currentQuestionIndex];
    document.getElementById('question-text').textContent = q.question_text;
    document.getElementById('option-a').textContent = q.option_a;
    document.getElementById('option-b').textContent = q.option_b;
    document.getElementById('option-c').textContent = q.option_c;
    document.getElementById('option-d').textContent = q.option_d;
    document.getElementById('current-question').textContent = currentQuestionIndex + 1;
    
    const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
    document.getElementById('progress').style.width = progress + '%';

    const saved = userAnswers[currentQuestionIndex];
    document.querySelectorAll('input[name="answer"]').forEach(r => r.checked = r.value === saved);
    
    // Update active state in navigation bar
    document.querySelectorAll('.q-num').forEach((el, idx) => {
        if (idx === currentQuestionIndex) {
            el.classList.add('active');
        } else {
            el.classList.remove('active');
        }
        
        // Mark as answered if user has selected an option
        if (userAnswers[idx]) {
            el.classList.add('answered');
        }
    });

    document.getElementById('prev-btn').style.display = currentQuestionIndex > 0 ? 'block' : 'none';
    if (currentQuestionIndex === questions.length - 1) {
        document.getElementById('next-btn').style.display = 'none';
        document.getElementById('submit-btn').style.display = 'block';
    } else {
        document.getElementById('next-btn').style.display = 'block';
        document.getElementById('submit-btn').style.display = 'none';
    }
}

function generateQuestionNumbers() {
    const container = document.getElementById('question-numbers');
    container.innerHTML = '';
    questions.forEach((_, index) => {
        const btn = document.createElement('div');
        btn.className = 'q-num';
        btn.textContent = index + 1;
        btn.onclick = () => {
            saveAnswer();
            currentQuestionIndex = index;
            displayQuestion();
        };
        container.appendChild(btn);
    });
}

function saveAnswer() {
    const selected = document.querySelector('input[name="answer"]:checked');
    if (selected) userAnswers[currentQuestionIndex] = selected.value;
}

document.getElementById('next-btn').onclick = () => { 
    saveAnswer(); 
    if (currentQuestionIndex < questions.length - 1) {
        currentQuestionIndex++; 
        displayQuestion();
    }
};

document.getElementById('prev-btn').onclick = () => { 
    saveAnswer(); 
    if (currentQuestionIndex > 0) {
        currentQuestionIndex--; 
        displayQuestion();
    }
};

function startTimer() {
    setInterval(() => {
        timeRemaining--;
        const h = Math.floor(timeRemaining / 3600);
        const m = Math.floor((timeRemaining % 3600) / 60);
        const s = timeRemaining % 60;
        
        let timeStr = "";
        if (h > 0) {
            timeStr = `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        } else {
            timeStr = `${m}:${s.toString().padStart(2, '0')}`;
        }
        
        document.getElementById('timer').textContent = timeStr;
        if (timeRemaining <= 0) submitQuiz();
    }, 1000);
}

async function submitQuiz() {
    saveAnswer();
    const answers = questions.map((q, i) => ({ question_id: q.id, answer: userAnswers[i] || null }));
    try {
        const res = await fetch('/submit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ answers })
        });
        const data = await res.json();
        window.location.href = `/result?score=${data.score}&total=${questions.length}`;
    } catch (error) {
        console.error('Error submitting quiz:', error);
        alert('Error submitting quiz. Please try again.');
    }
}

document.getElementById('quiz-form').onsubmit = (e) => { e.preventDefault(); submitQuiz(); };
window.onload = loadQuestions;
</script>
{% endblock %}
